import{d as i,w as m}from"./CMDLyNOv.js";import{b as W}from"./Bt-Xh7oU.js";function y(){const{subscribe:c,set:a,update:s}=m({status:"disconnected",lastMessage:null,error:null});let e=null,l=null,r=0;const u=5,b=3e3;function p(){const o="wss://tradesense-backend-production.up.railway.app/ws";try{console.log("Attempting WebSocket connection to:",o),s(t=>({...t,status:"connecting",error:null})),e=new WebSocket(o),e.onopen=()=>{console.log("WebSocket connected"),r=0,s(n=>({...n,status:"connected"}));const t=W?localStorage.getItem("authToken"):null;t&&e&&e.send(JSON.stringify({type:"auth",token:t}))},e.onmessage=t=>{try{const n=JSON.parse(t.data);s(f=>({...f,lastMessage:n})),S(n)}catch(n){console.error("Failed to parse WebSocket message:",n)}},e.onerror=t=>{console.error("WebSocket error:",t),s(n=>({...n,status:"error",error:"WebSocket connection error"}))},e.onclose=()=>{console.log("WebSocket disconnected"),s(t=>({...t,status:"disconnected"})),r<u?(r++,console.log(`Reconnecting... (attempt ${r}/${u})`),l=setTimeout(()=>{p()},b*r)):s(t=>({...t,error:"Failed to reconnect after multiple attempts"}))}}catch(t){console.error("Failed to create WebSocket connection:",t),s(n=>({...n,status:"error",error:"Failed to create WebSocket connection"}))}}function k(){l&&(clearTimeout(l),l=null),e&&e.readyState===WebSocket.OPEN&&e.close(),e=null,r=0}function g(o){e&&e.readyState===WebSocket.OPEN?e.send(JSON.stringify(o)):console.error("WebSocket is not connected")}function S(o){switch(o.type){case"trade_update":console.log("Trade update:",o.data);break;case"price_update":console.log("Price update:",o.data);break;case"notification":console.log("Notification:",o.data);break;case"market_status":console.log("Market status:",o.data);break}}return{subscribe:c,connect:p,disconnect:k,send:g}}const d=y(),h=i(d,c=>c.status==="connected");i(d,c=>{var a;return((a=c.lastMessage)==null?void 0:a.type)==="trade_update"?c.lastMessage.data:null});const N=i(d,c=>{var a;return((a=c.lastMessage)==null?void 0:a.type)==="price_update"?c.lastMessage.data:null});export{h as a,N as p,d as w};

import{d as i,w as h}from"./BnGq5l0c.js";import{b as y}from"./Bt-Xh7oU.js";function M(){const{subscribe:c,set:r,update:s}=h({status:"disconnected",lastMessage:null,error:null});let e=null,l=null,a=0;const u=5,k=3e3;function p(){const o="http://localhost:8000",m=o.startsWith("https")?"wss":"ws",W=o.replace(/^https?:\/\//,""),b=`${m}://${W}/ws`;try{console.log("Attempting WebSocket connection to:",b),s(t=>({...t,status:"connecting",error:null})),e=new WebSocket(b),e.onopen=()=>{console.log("WebSocket connected"),a=0,s(n=>({...n,status:"connected"}));const t=y?localStorage.getItem("authToken"):null;t&&e&&e.send(JSON.stringify({type:"auth",token:t}))},e.onmessage=t=>{try{const n=JSON.parse(t.data);s(w=>({...w,lastMessage:n})),f(n)}catch(n){console.error("Failed to parse WebSocket message:",n)}},e.onerror=t=>{console.error("WebSocket error:",t),s(n=>({...n,status:"error",error:"WebSocket connection error"}))},e.onclose=()=>{console.log("WebSocket disconnected"),s(t=>({...t,status:"disconnected"})),a<u?(a++,console.log(`Reconnecting... (attempt ${a}/${u})`),l=setTimeout(()=>{p()},k*a)):s(t=>({...t,error:"Failed to reconnect after multiple attempts"}))}}catch(t){console.error("Failed to create WebSocket connection:",t),s(n=>({...n,status:"error",error:"Failed to create WebSocket connection"}))}}function g(){l&&(clearTimeout(l),l=null),e&&e.readyState===WebSocket.OPEN&&e.close(),e=null,a=0}function S(o){e&&e.readyState===WebSocket.OPEN?e.send(JSON.stringify(o)):console.error("WebSocket is not connected")}function f(o){switch(o.type){case"trade_update":console.log("Trade update:",o.data);break;case"price_update":console.log("Price update:",o.data);break;case"notification":console.log("Notification:",o.data);break;case"market_status":console.log("Market status:",o.data);break}}return{subscribe:c,connect:p,disconnect:g,send:S}}const d=M(),T=i(d,c=>c.status==="connected");i(d,c=>{var r;return((r=c.lastMessage)==null?void 0:r.type)==="trade_update"?c.lastMessage.data:null});const _=i(d,c=>{var r;return((r=c.lastMessage)==null?void 0:r.type)==="price_update"?c.lastMessage.data:null});export{T as a,_ as p,d as w};

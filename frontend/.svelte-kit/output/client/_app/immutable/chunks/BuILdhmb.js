import{d as p,w as A,g as z}from"./_pMazo4M.js";import{a as s}from"./DL1kKP1L.js";function J(){const{subscribe:u,set:g,update:c}=A({user:null,token:null,loading:!0,initialized:!1});let f;async function w(){const e=localStorage.getItem("auth_token"),t=localStorage.getItem("user");if(e&&t)try{const r=JSON.parse(t);s.setAuthToken(e),c(a=>({...a,user:r,token:e,loading:!1,initialized:!0})),await y(),d()}catch(r){console.error("Failed to initialize auth:",r),await h()}else c(r=>({...r,loading:!1,initialized:!0}))}async function I(e,t,r){var a,o,i;try{const n=await s.post("/api/v1/auth/login",{email:e,password:t,mfa_code:r}),{access_token:l,user:m}=n.data;return localStorage.setItem("auth_token",l),localStorage.setItem("user",JSON.stringify(m)),s.setAuthToken(l),c(v=>({...v,user:m,token:l,loading:!1})),d(),{success:!0}}catch(n){return{success:!1,error:((o=(a=n.response)==null?void 0:a.data)==null?void 0:o.detail)||"Login failed",requiresMfa:((i=n.response)==null?void 0:i.status)===428}}}async function T(e,t,r){var a,o;try{const i=await s.post("/api/v1/auth/register",{email:e,password:t,name:r}),{access_token:n,user:l}=i.data;return localStorage.setItem("auth_token",n),localStorage.setItem("user",JSON.stringify(l)),s.setAuthToken(n),c(m=>({...m,user:l,token:n,loading:!1})),d(),{success:!0}}catch(i){return{success:!1,error:((o=(a=i.response)==null?void 0:a.data)==null?void 0:o.detail)||"Registration failed"}}}async function h(){try{await s.post("/api/v1/auth/logout")}catch(e){console.error("Logout error:",e)}finally{localStorage.removeItem("auth_token"),localStorage.removeItem("user"),s.clearAuth(),f&&clearTimeout(f),g({user:null,token:null,loading:!1,initialized:!0}),z("/login")}}async function y(){try{const t=(await s.get("/api/v1/auth/me")).data;return localStorage.setItem("user",JSON.stringify(t)),c(r=>({...r,user:t})),!0}catch(e){return console.error("Auth check failed:",e),await h(),!1}}async function S(){try{const e=await s.post("/api/v1/auth/refresh"),{access_token:t}=e.data;return localStorage.setItem("auth_token",t),s.setAuthToken(t),c(r=>({...r,token:t})),d(),!0}catch(e){return console.error("Token refresh failed:",e),await h(),!1}}function d(){f&&clearTimeout(f),f=setTimeout(()=>{S()},25*60*1e3)}async function _(e){var t,r;try{const o=(await s.patch("/api/v1/auth/me",e)).data;return localStorage.setItem("user",JSON.stringify(o)),c(i=>({...i,user:o})),{success:!0}}catch(a){return{success:!1,error:((r=(t=a.response)==null?void 0:t.data)==null?void 0:r.detail)||"Update failed"}}}return{subscribe:u,login:I,register:T,logout:h,checkAuth:y,refreshToken:S,updateUser:_,initialize:w}}const k=J();p(k,u=>u.user);p(k,u=>!!u.user);p(k,u=>{var g;return((g=u.user)==null?void 0:g.is_admin)||!1});export{k as a};

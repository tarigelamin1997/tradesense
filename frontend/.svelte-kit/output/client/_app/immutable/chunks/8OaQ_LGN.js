import{d as p,w as A,g as T}from"./BlAxCd93.js";import{a}from"./Dt6aPy9N.js";function J(){const{subscribe:u,set:d,update:c}=A({user:null,token:null,loading:!0,initialized:!1});let f;async function y(){const e=localStorage.getItem("auth_token"),t=localStorage.getItem("user");if(e&&t)try{const r=JSON.parse(t);a.defaults.headers.common.Authorization=`Bearer ${e}`,c(s=>({...s,user:r,token:e,loading:!1,initialized:!0})),await S(),h()}catch(r){console.error("Failed to initialize auth:",r),await g()}else c(r=>({...r,loading:!1,initialized:!0}))}async function z(e,t,r){var s,o,i;try{const n=await a.post("/api/v1/auth/login",{email:e,password:t,mfa_code:r}),{access_token:l,user:m}=n.data;return localStorage.setItem("auth_token",l),localStorage.setItem("user",JSON.stringify(m)),a.defaults.headers.common.Authorization=`Bearer ${l}`,c(v=>({...v,user:m,token:l,loading:!1})),h(),{success:!0}}catch(n){return{success:!1,error:((o=(s=n.response)==null?void 0:s.data)==null?void 0:o.detail)||"Login failed",requiresMfa:((i=n.response)==null?void 0:i.status)===428}}}async function I(e,t,r){var s,o;try{const i=await a.post("/api/v1/auth/register",{email:e,password:t,name:r}),{access_token:n,user:l}=i.data;return localStorage.setItem("auth_token",n),localStorage.setItem("user",JSON.stringify(l)),a.defaults.headers.common.Authorization=`Bearer ${n}`,c(m=>({...m,user:l,token:n,loading:!1})),h(),{success:!0}}catch(i){return{success:!1,error:((o=(s=i.response)==null?void 0:s.data)==null?void 0:o.detail)||"Registration failed"}}}async function g(){try{await a.post("/api/v1/auth/logout")}catch(e){console.error("Logout error:",e)}finally{localStorage.removeItem("auth_token"),localStorage.removeItem("user"),delete a.defaults.headers.common.Authorization,f&&clearTimeout(f),d({user:null,token:null,loading:!1,initialized:!0}),T("/login")}}async function S(){try{const t=(await a.get("/api/v1/auth/me")).data;return localStorage.setItem("user",JSON.stringify(t)),c(r=>({...r,user:t})),!0}catch(e){return console.error("Auth check failed:",e),await g(),!1}}async function w(){try{const e=await a.post("/api/v1/auth/refresh"),{access_token:t}=e.data;return localStorage.setItem("auth_token",t),a.defaults.headers.common.Authorization=`Bearer ${t}`,c(r=>({...r,token:t})),h(),!0}catch(e){return console.error("Token refresh failed:",e),await g(),!1}}function h(){f&&clearTimeout(f),f=setTimeout(()=>{w()},25*60*1e3)}async function _(e){var t,r;try{const o=(await a.patch("/api/v1/auth/me",e)).data;return localStorage.setItem("user",JSON.stringify(o)),c(i=>({...i,user:o})),{success:!0}}catch(s){return{success:!1,error:((r=(t=s.response)==null?void 0:t.data)==null?void 0:r.detail)||"Update failed"}}}return y(),{subscribe:u,login:z,register:I,logout:g,checkAuth:S,refreshToken:w,updateUser:_,initialize:y}}const k=J();p(k,u=>u.user);p(k,u=>!!u.user);p(k,u=>{var d;return((d=u.user)==null?void 0:d.is_admin)||!1});export{k as a};

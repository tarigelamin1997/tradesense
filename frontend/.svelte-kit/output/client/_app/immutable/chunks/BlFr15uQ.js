import{p as o}from"./9_quCCnq.js";class c{constructor(){this.queue=[],this.sessionId=this.generateSessionId(),this.apiEndpoint="/api/v1/analytics/track",this.flushInterval=5e3,this.batchSize=10,this.startAutoFlush(),this.setupPageTracking(),this.setupErrorTracking(),this.setupPerformanceTracking()}async track(e,t={}){var i;const r={event_type:e,properties:{...t,timestamp:new Date().toISOString(),user_agent:(navigator==null?void 0:navigator.userAgent)||"",screen_resolution:window!=null&&window.screen?`${window.screen.width}x${window.screen.height}`:"",viewport_size:window?`${window.innerWidth}x${window.innerHeight}`:"",referrer:(document==null?void 0:document.referrer)||"",page_title:(document==null?void 0:document.title)||""},page_url:((i=window==null?void 0:window.location)==null?void 0:i.href)||"",referrer_url:(document==null?void 0:document.referrer)||"",session_id:this.sessionId};this.queue.push(r),this.queue.length>=this.batchSize&&await this.flush()}trackPageView(e,t={}){this.track("page_view",{url:e,...t})}trackAction(e,t,r={}){this.track("user_action",{action:e,category:t,...r})}trackFeature(e,t={}){this.track("feature_discovered",{feature_name:e,...t})}trackError(e,t={}){this.track("error_occurred",{error_message:e.message||String(e),error_stack:e.stack,...t})}trackTiming(e,t,r,i={}){this.track("timing",{category:e,variable:t,value:r,...i})}trackTrade(e,t){const r={create:"trade_created",update:"trade_updated",delete:"trade_deleted",import:"trade_imported"};this.track(r[e]||"trade_created",{trade_id:t.id,symbol:t.symbol,trade_type:t.trade_type,quantity:t.quantity,value:t.entry_price*t.quantity,profit_loss:t.profit_loss})}trackSubscription(e,t,r){const i={started:"subscription_started",upgraded:"subscription_upgraded",downgraded:"subscription_downgraded",cancelled:"subscription_cancelled"};this.track(i[e]||"subscription_started",{plan:t,price:r,currency:"USD"})}async flush(){if(this.queue.length===0)return;const e=[...this.queue];this.queue=[];try{for(const t of e)await fetch(this.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getAuthToken()}`},body:JSON.stringify(t)})}catch(t){console.error("Failed to send analytics:",t),this.queue=[...e,...this.queue]}}setupPageTracking(){this.trackPageView(window.location.href),o.subscribe(t=>{t.url&&this.trackPageView(t.url.href,{route_id:t.route.id,params:t.params})});let e=Date.now();window.addEventListener("beforeunload",()=>{const t=Date.now()-e;this.track("page_exit",{time_on_page:t,url:window.location.href}),navigator!=null&&navigator.sendBeacon&&navigator.sendBeacon(this.apiEndpoint,JSON.stringify({events:this.queue}))})}setupErrorTracking(){window.addEventListener("error",e=>{this.trackError(e.error||e,{filename:e.filename,line_number:e.lineno,column_number:e.colno})}),window.addEventListener("unhandledrejection",e=>{this.trackError(e.reason,{type:"unhandled_promise_rejection"})})}setupPerformanceTracking(){if(window.performance&&window.performance.timing&&window.addEventListener("load",()=>{setTimeout(()=>{const e=window.performance.timing,t=e.loadEventEnd-e.navigationStart,r=e.domContentLoadedEventEnd-e.navigationStart,i=this.getFirstPaintTime();this.track("page_performance",{page_load_time:t,dom_ready_time:r,first_paint_time:i,url:window.location.href})},0)}),"PerformanceObserver"in window)try{new PerformanceObserver(s=>{const a=s.getEntries(),n=a[a.length-1];this.track("web_vital",{metric:"lcp",value:n.startTime,url:window.location.href})}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(s=>{s.getEntries().forEach(n=>{this.track("web_vital",{metric:"fid",value:n.processingStart-n.startTime,url:window.location.href})})}).observe({entryTypes:["first-input"]});let r=0;new PerformanceObserver(s=>{s.getEntries().forEach(n=>{n.hadRecentInput||(r+=n.value)})}).observe({entryTypes:["layout-shift"]}),window.addEventListener("beforeunload",()=>{this.track("web_vital",{metric:"cls",value:r,url:window.location.href})})}catch(e){console.error("Failed to set up performance observers:",e)}}startAutoFlush(){setInterval(()=>{this.flush()},this.flushInterval)}generateSessionId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}getAuthToken(){return localStorage.getItem("auth_token")||""}getFirstPaintTime(){if(window.performance&&window.performance.getEntriesByType){const t=window.performance.getEntriesByType("paint").find(r=>r.name==="first-paint");return t?t.startTime:null}return null}identify(e,t={}){this.track("user_identified",{user_id:e,traits:t})}trackForm(e,t,r={}){this.track("form_interaction",{form_name:e,action:t,...r})}trackClick(e,t={}){var r,i;this.track("element_clicked",{element_text:(r=e.textContent)==null?void 0:r.trim(),element_type:(i=e.tagName)==null?void 0:i.toLowerCase(),element_class:e.className,element_id:e.id,...t})}}const d=new c,{track:h,trackPageView:p,trackAction:m,trackFeature:w,trackError:f,trackTiming:g,trackTrade:_,trackSubscription:k,identify:v,trackForm:y,trackClick:b}=d;export{d as a};
